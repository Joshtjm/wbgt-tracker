{% extends "layout.html" %}
{% block content %}
<div class="flex flex-col items-center p-4">

  <!-- Header -->
  <h2 class="text-xl font-bold mb-4">WBGT Tracker</h2>

  <!-- Timer Circle -->
  <div class="relative w-48 h-48">
    <svg class="absolute top-0 left-0 w-full h-full transform -rotate-90" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="45" stroke="#e5e7eb" stroke-width="10" fill="none" />
      <circle id="progress-ring" cx="50" cy="50" r="45" stroke="#10b981" stroke-width="10" fill="none"
        stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round" />
    </svg>
    <div class="absolute inset-0 flex flex-col items-center justify-center">
      <div id="countdown" class="text-3xl font-bold text-gray-700">--:--</div>
      <div class="text-sm mt-1 text-gray-600" id="zone_name_display">Zone: {{ user.zone.title() }}</div>
    </div>
  </div>

  <!-- Start & End Time -->
  <div class="mt-3 text-sm text-gray-600">
    Start: {{ user.start_time }} · End: {{ user.end_time }}
  </div>

  <!-- WBGT Zone Selector -->
  <h3 class="mt-6 text-lg font-semibold">WBGT Zones</h3>
  <p class="text-sm text-gray-500 mb-3">Select a zone to start the work/rest cycle.</p>

  <form action="/" method="POST" class="w-full max-w-xs space-y-2">
    <input type="hidden" name="username" value="{{ username }}">
    {% for key, z in zones.items() %}
    <button name="zone" value="{{ key }}" class="w-full p-4 rounded shadow text-left
      {% if key == 'white' %}bg-white text-black
      {% elif key == 'green' %}bg-green-400 text-white
      {% elif key == 'yellow' %}bg-yellow-300 text-black
      {% elif key == 'red' %}bg-red-400 text-white
      {% elif key == 'black' %}bg-black text-white
      {% endif %}
      hover:scale-[1.02] transition">
      <div class="font-bold text-lg">{{ key.title() }} Zone</div>
      <div class="text-sm">
        Work: {{ z.work }} mins · Rest: {{ z.rest }} mins<br>
        {% if z.min and z.max %}
        Temp: {{ "%.1f"|format(z.min) }}°C – {{ "%.1f"|format(z.max) }}°C
        {% elif z.min %}
        Temp: {{ "%.1f"|format(z.min) }}°C and above
        {% else %}
        Temp: N/A
        {% endif %}
      </div>
    </button>
    {% endfor %}
  </form>
</div>

<!-- Countdown Script -->
<script>
  const endTimeStr = "{{ user.end_time }}";
  const status = "{{ user.status }}";

  if (endTimeStr && status === "working") {
    const endParts = endTimeStr.split(":");
    const end = new Date();
    end.setHours(parseInt(endParts[0]));
    end.setMinutes(parseInt(endParts[1]));
    end.setSeconds(parseInt(endParts[2]));

    const totalSeconds = Math.floor((end - new Date()) / 1000);
    const progress = document.getElementById("progress-ring");
    const radius = 45;
    const circumference = 2 * Math.PI * radius;
    progress.style.strokeDasharray = circumference;

    const interval = setInterval(() => {
      const now = new Date();
      const diff = Math.floor((end - now) / 1000);
      const mins = Math.floor(diff / 60);
      const secs = diff % 60;

      document.getElementById("countdown").textContent =
        `${String(Math.max(mins, 0)).padStart(2, '0')}:${String(Math.max(secs, 0)).padStart(2, '0')}`;

      progress.style.strokeDashoffset = circumference * (1 - diff / totalSeconds);

      if (diff <= 0) {
        clearInterval(interval);
        progress.style.strokeDashoffset = circumference;
        document.getElementById("countdown").textContent = "--:--";
      }
    }, 1000);
  }
</script>
{% endblock %}
