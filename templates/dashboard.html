
{% extends "layout.html" %}
{% block content %}
<div class="flex flex-col items-center p-4">
  <h2 class="text-xl font-bold mb-4">WBGT Tracker</h2>
  <div class="text-sm text-gray-600 mb-4">Logged in as: {{ username }} ({{ user.role }})</div>

  <!-- Timer Circle -->
  <div class="relative w-48 h-48">
    <svg class="absolute top-0 left-0 w-full h-full transform -rotate-90" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="45" stroke="#e5e7eb" stroke-width="10" fill="none" />
      <circle id="progress-ring" cx="50" cy="50" r="45" stroke="#10b981" stroke-width="10" fill="none"
        stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round" />
    </svg>
    <div class="absolute inset-0 flex flex-col items-center justify-center">
      <div id="countdown" class="text-3xl font-bold {% if user.zone %}text-{{ user.zone }}-600{% else %}text-gray-700{% endif %}">--:--</div>
      <div class="text-sm mt-1 text-gray-600" id="zone_name_display">
        {% if user.zone %}Zone: {{ user.zone.title() }}{% endif %}
      </div>
      <div class="text-xs text-gray-500">
        {% if user.start_time and user.end_time %}
        {{ user.start_time }} - {{ user.end_time }}
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Location Section -->
  <div class="absolute top-4 right-4 w-64">
    <div class="flex space-x-2 mb-4">
      <input type="text" id="location_name" placeholder="Location name" class="flex-1 p-2 border rounded">
      <button onclick="saveCurrentLocation()" class="bg-blue-500 text-white px-4 py-2 rounded">Save</button>
    </div>
    <select id="saved_locations" class="w-full p-2 border rounded mb-4">
      <option value="">Select saved location</option>
    </select>
    <div id="current_location" class="text-sm text-gray-600 mb-4"></div>
  </div>

  <!-- WBGT Zone Selector -->
  <h3 class="mt-6 text-lg font-semibold">WBGT Zones</h3>
  {% if system_status.cut_off %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4">
      <strong class="font-bold">Cut-Off Mode Active!</strong>
      <p class="text-sm">All activities must stop. Please wait for further instructions.</p>
    </div>
  {% elif system_status.cut_off_end_time %}
    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative mb-4">
      <strong class="font-bold">Mandatory Rest Period</strong>
      <p class="text-sm">Normal activities will resume after: {{ system_status.cut_off_end_time }}</p>
    </div>
  {% endif %}
  <div class="w-full max-w-xs space-y-2" {% if system_status.cut_off or (system_status.cut_off_end_time and user.role == 'Trainer') %}style="pointer-events: none; opacity: 0.5"{% endif %}>
    {% for key, z in zones.items() %}
    <button onclick="startZone('{{ key }}')" class="w-full p-4 rounded shadow text-left
      {% if key == 'white' %}bg-white text-black
      {% elif key == 'green' %}bg-green-400 text-white
      {% elif key == 'yellow' %}bg-yellow-300 text-black
      {% elif key == 'red' %}bg-red-400 text-white
      {% elif key == 'black' %}bg-black text-white
      {% endif %}
      hover:scale-[1.02] transition">
      <div class="font-bold text-lg">{{ key.title() }} Zone</div>
      <div class="text-sm">Work: {{ z.work }} mins Â· Rest: {{ z.rest }} mins</div>
    </button>
    {% endfor %}
  </div>
</div>

<script>
let currentPosition = null;

function updateLocationDisplay() {
  if (currentPosition) {
    document.getElementById('current_location').textContent = 
      `Current location: ${currentPosition.coords.latitude.toFixed(6)}, ${currentPosition.coords.longitude.toFixed(6)}`;
  }
}

function loadSavedLocations() {
  fetch('/get_locations')
    .then(response => response.json())
    .then(locations => {
      const select = document.getElementById('saved_locations');
      select.innerHTML = '<option value="">Select saved location</option>';
      for (const [name, coords] of Object.entries(locations)) {
        select.innerHTML += `<option value="${coords.lat},${coords.lng}">${name}</option>`;
      }
    });
}

function saveCurrentLocation() {
  const name = document.getElementById('location_name').value;
  if (!name || !currentPosition) return;
  
  fetch('/save_location', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name: name,
      lat: currentPosition.coords.latitude,
      lng: currentPosition.coords.longitude
    })
  }).then(() => {
    loadSavedLocations();
    document.getElementById('location_name').value = '';
  });
}

function startZone(zone) {
  const locationSelect = document.getElementById('saved_locations');
  const location = locationSelect.value || 
    (currentPosition ? `${currentPosition.coords.latitude},${currentPosition.coords.longitude}` : '');
    
  fetch('/set_zone', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `username={{ username }}&zone=${zone}&location=${location}`
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => {
        throw new Error(err.error || 'Failed to set zone');
      });
    }
    return response.json();
  })
  .then(() => {
    updateDashboard();
  })
  .catch(error => {
    alert(error.message);
  });
}

function updateDashboard() {
  fetch('/get_updates')
    .then(response => response.json())
    .then(data => {
      const userData = data.users['{{ username }}'];
      if (userData) {
        document.getElementById('zone_name_display').innerHTML = 
          userData.zone ? `Zone: ${userData.zone.charAt(0).toUpperCase() + userData.zone.slice(1)}` : '';
        
        if (userData.start_time && userData.end_time) {
          startTimer(userData.end_time);
        } else {
          clearTimer();
        }
      }
      
      // Update system status displays
      if (data.system_status.cut_off) {
        document.querySelector('.w-full.max-w-xs').style.pointerEvents = 'none';
        document.querySelector('.w-full.max-w-xs').style.opacity = '0.5';
      } else {
        document.querySelector('.w-full.max-w-xs').style.pointerEvents = '';
        document.querySelector('.w-full.max-w-xs').style.opacity = '';
      }
    });
}

// Auto-update every 5 seconds
setInterval(updateDashboard, 5000);

if (navigator.geolocation) {
  navigator.geolocation.watchPosition(
    (position) => {
      currentPosition = position;
      updateLocationDisplay();
    },
    null,
    { enableHighAccuracy: true }
  );
}

loadSavedLocations();

// Timer code
const endTimeStr = "{{ user.end_time }}";
const status = "{{ user.status }}";

if (endTimeStr && status === "working") {
  const endParts = endTimeStr.split(":");
  const end = new Date();
  end.setHours(parseInt(endParts[0]));
  end.setMinutes(parseInt(endParts[1]));
  end.setSeconds(parseInt(endParts[2]));

  const totalSeconds = Math.floor((end - new Date()) / 1000);
  const progress = document.getElementById("progress-ring");
  const radius = 45;
  const circumference = 2 * Math.PI * radius;
  progress.style.strokeDasharray = circumference;

  const interval = setInterval(() => {
    const now = new Date();
    const diff = Math.floor((end - now) / 1000);
    const mins = Math.floor(diff / 60);
    const secs = diff % 60;

    document.getElementById("countdown").textContent =
      `${String(Math.max(mins, 0)).padStart(2, '0')}:${String(Math.max(secs, 0)).padStart(2, '0')}`;

    progress.style.strokeDashoffset = circumference * (1 - diff / totalSeconds);

    if (diff <= 0) {
      clearInterval(interval);
      progress.style.strokeDashoffset = circumference;
      document.getElementById("countdown").textContent = "--:--";
    }
  }, 1000);
}
</script>
{% endblock %}
