{% extends "layout.html" %}
{% block content %}
<div class="flex flex-col items-center">
  <h2 class="text-xl font-semibold mt-4">WBGT Tracker</h2>

  <!-- Countdown Ring -->
  <div class="relative w-48 h-48 my-4">
    <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="45" stroke="#e5e7eb" stroke-width="10" fill="none" />
      <circle id="progress-ring" cx="50" cy="50" r="45" stroke="#10b981" stroke-width="10" fill="none"
              stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round" />
    </svg>
    <div class="absolute inset-0 flex items-center justify-center text-3xl font-bold text-gray-700" id="countdown">--:--</div>
  </div>

  <!-- Zone Info -->
  <p class="mt-2 font-medium text-center" id="zone_display">
    {% if user.status == 'working' %}
      ðŸŸ¢ Currently in <strong>{{ user.zone.title() }}</strong> zone
    {% else %}
      Please select a WBGT zone below
    {% endif %}
  </p>
  <p class="text-sm mt-1 text-gray-600">
    {% if user.status == 'working' %}
      Start: {{ user.start_time }} Â· End: {{ user.end_time }}
    {% endif %}
  </p>

  <!-- Zone Selector -->
  <form method="POST" action="/">
    <input type="hidden" name="username" value="{{ username }}">
    <div class="mt-6 space-y-2 w-full max-w-xs">
      {% for key, z in zones.items() %}
      <button name="zone" value="{{ key }}" type="submit"
        class="w-full p-4 rounded text-white shadow
        {% if key == 'white' %}bg-white text-black border border-gray-300{% endif %}
        {% if key == 'green' %}bg-green-500{% endif %}
        {% if key == 'yellow' %}bg-yellow-400{% endif %}
        {% if key == 'red' %}bg-red-500{% endif %}
        {% if key == 'black' %}bg-black{% endif %}">
        <strong>{{ key.title() }} Zone</strong><br>
        <span class="text-sm">Work: {{ z.work }}m Â· Rest: {{ z.rest }}m</span>
      </button>
      {% endfor %}
    </div>
  </form>
</div>

<script>
let endTimeStr = "{{ user.end_time }}";
let userStatus = "{{ user.status }}";
if (userStatus === 'working' && endTimeStr !== "--:--") {
  const [h, m, s] = endTimeStr.split(":").map(Number);
  const now = new Date();
  const end = new Date();
  end.setHours(h, m, s);
  
  if (end > now) {
    const total = Math.floor((end - now) / 1000);
    const ring = document.getElementById("progress-ring");
    const count = document.getElementById("countdown");
    const circ = 2 * Math.PI * 45;
    ring.style.strokeDasharray = circ;

    let remaining = total;
    const interval = setInterval(() => {
      let mins = Math.floor(remaining / 60);
      let secs = remaining % 60;
      count.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      ring.style.strokeDashoffset = circ * (remaining / total);

      if (--remaining < 0) {
        clearInterval(interval);
        count.textContent = "--:--";
        ring.style.strokeDashoffset = 0;
      }
    }, 1000);
  }
}
</script>
{% endblock %}
