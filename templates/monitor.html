
{% extends "layout.html" %}
{% block content %}
<div class="flex flex-col items-center p-4 max-w-4xl mx-auto">
  <h2 class="text-xl font-bold mb-4">WBGT Status Monitor</h2>
  <div class="text-sm text-gray-600 mb-4">Logged in as: {{ username }} ({{ role }})</div>

  <!-- Control Panel -->
  <div class="w-full mb-6 space-y-4">
    <!-- Cut-off Control -->
    <div class="bg-white p-4 rounded shadow">
      <h3 class="font-bold mb-2">System Control</h3>
      <div class="flex flex-col sm:flex-row gap-4">
        <button onclick="toggleCutOff()" class="flex-1 p-3 rounded text-white font-bold
          {% if system_status.cut_off %}
          bg-red-600 hover:bg-red-700
          {% else %}
          bg-green-600 hover:bg-green-700
          {% endif %}">
          {% if system_status.cut_off %}
          Deactivate Cut-Off Mode
          {% else %}
          Activate Cut-Off Mode
          {% endif %}
        </button>
        <button onclick="resetLogs()" class="flex-1 p-3 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded">
          Reset User Logs
        </button>
      </div>
      {% if system_status.cut_off_end_time %}
      <div class="mt-2 text-center text-red-600">
        Mandatory rest until: {{ system_status.cut_off_end_time }}
      </div>
      {% endif %}
    </div>

    <!-- WBGT Zone Control -->
    <div class="bg-white p-4 rounded shadow">
      <h3 class="font-bold mb-2">Modify WBGT Zones</h3>
      <div class="flex flex-col sm:flex-row gap-4">
        <select id="userSelect" multiple class="flex-1 p-2 border rounded min-h-[100px]">
          {% for user_id, user_data in users.items() %}
            {% if user_data.get('role') == 'Trainer' %}
              <option value="{{ user_id }}">{{ user_id }}</option>
            {% endif %}
          {% endfor %}
        </select>
        <div class="flex flex-col gap-2">
          {% for zone in zones %}
            {% if zone != 'cut-off' %}
            <button onclick="updateSelectedUsers('{{ zone }}')" 
              class="p-2 rounded text-sm font-semibold
              {% if zone == 'white' %}bg-white border border-gray-300 text-black
              {% elif zone == 'green' %}bg-green-400 text-white
              {% elif zone == 'yellow' %}bg-yellow-300 text-black
              {% elif zone == 'red' %}bg-red-400 text-white
              {% elif zone == 'black' %}bg-black text-white{% endif %}">
              {{ zone|title }}
            </button>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="w-full overflow-x-auto bg-white shadow rounded-lg">
    <table class="min-w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Zone</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Start</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">End</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% for user_id, user_data in users.items() %}
          {% if user_data.get('role') == 'Trainer' %}
            <tr>
              <td class="px-4 py-3 text-sm">{{ user_id }}</td>
              <td class="px-4 py-3 text-sm">{{ user_data.status|title }}</td>
              <td class="px-4 py-3">
                <span class="px-2 py-1 text-sm rounded
                  {% if user_data.zone == 'white' %}bg-white border border-gray-300 text-black
                  {% elif user_data.zone == 'green' %}bg-green-400 text-white
                  {% elif user_data.zone == 'yellow' %}bg-yellow-300 text-black
                  {% elif user_data.zone == 'red' %}bg-red-400 text-white
                  {% elif user_data.zone == 'black' %}bg-black text-white
                  {% elif user_data.zone == 'cut-off' %}bg-red-600 text-white{% endif %}">
                  {{ user_data.zone|title if user_data.zone else '-' }}
                </span>
              </td>
              <td class="px-4 py-3 text-sm">{{ user_data.get('start_time', '-') }}</td>
              <td class="px-4 py-3 text-sm">{{ user_data.get('end_time', '-') }}</td>
            </tr>
          {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
function toggleCutOff() {
  fetch('/toggle_cut_off', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `username={{ username }}`
  }).then(() => window.location.reload());
}

function resetLogs() {
  if (confirm('Are you sure you want to reset all user logs?')) {
    fetch('/reset_logs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `username={{ username }}`
    }).then(() => window.location.reload());
  }
}

function updateSelectedUsers(zone) {
  const selectedUsers = Array.from(document.getElementById('userSelect').selectedOptions).map(opt => opt.value);
  if (!selectedUsers.length) return;
  
  Promise.all(selectedUsers.map(user => 
    fetch('/set_zone', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `username={{ username }}&target_user=${user}&zone=${zone}`
    })
  )).then(() => window.location.reload());
}
</script>
{% endblock %}
